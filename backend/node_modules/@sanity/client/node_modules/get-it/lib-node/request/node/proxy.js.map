{"version":3,"sources":["../../../src/request/node/proxy.js"],"names":["url","require","objectAssign","formatHostname","hostname","replace","toLowerCase","parseNoProxyZone","zoneStr","zone","trim","zoneParts","split","zoneHost","zonePort","hasPort","indexOf","port","uriInNoProxy","uri","noProxy","protocol","noProxyList","map","some","noProxyZone","isMatchedAt","hostnameMatched","length","getProxyFromUri","process","env","NO_PROXY","no_proxy","HTTP_PROXY","http_proxy","HTTPS_PROXY","https_proxy","getHostFromUri","host","getHostHeaderWithPort","rewriteUriForProxy","reqOpts","proxy","headers","options","href","path","format","getProxyOptions","hasOwnProperty","parse","exports"],"mappings":"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","sourcesContent":["/**\n * Code borrowed from https://github.com/request/request\n * Apache License 2.0\n */\n\n/* eslint-disable no-process-env */\nconst url = require('url')\nconst objectAssign = require('object-assign')\n\nfunction formatHostname(hostname) {\n  // canonicalize the hostname, so that 'oogle.com' won't match 'google.com'\n  return hostname.replace(/^\\.*/, '.').toLowerCase()\n}\n\nfunction parseNoProxyZone(zoneStr) {\n  const zone = zoneStr.trim().toLowerCase()\n\n  const zoneParts = zone.split(':', 2)\n  const zoneHost = formatHostname(zoneParts[0])\n  const zonePort = zoneParts[1]\n  const hasPort = zone.indexOf(':') > -1\n\n  return {hostname: zoneHost, port: zonePort, hasPort: hasPort}\n}\n\nfunction uriInNoProxy(uri, noProxy) {\n  const port = uri.port || (uri.protocol === 'https:' ? '443' : '80')\n  const hostname = formatHostname(uri.hostname)\n  const noProxyList = noProxy.split(',')\n\n  // iterate through the noProxyList until it finds a match.\n  return noProxyList.map(parseNoProxyZone).some(noProxyZone => {\n    const isMatchedAt = hostname.indexOf(noProxyZone.hostname)\n    const hostnameMatched =\n      isMatchedAt > -1 && isMatchedAt === hostname.length - noProxyZone.hostname.length\n\n    if (noProxyZone.hasPort) {\n      return port === noProxyZone.port && hostnameMatched\n    }\n\n    return hostnameMatched\n  })\n}\n\nfunction getProxyFromUri(uri) {\n  // Decide the proper request proxy to use based on the request URI object and the\n  // environmental variables (NO_PROXY, HTTP_PROXY, etc.)\n  // respect NO_PROXY environment variables (see: http://lynx.isc.org/current/breakout/lynx_help/keystrokes/environments.html)\n  const noProxy = process.env.NO_PROXY || process.env.no_proxy || ''\n\n  // if the noProxy is a wildcard then return null\n  if (noProxy === '*') {\n    return null\n  }\n\n  // if the noProxy is not empty and the uri is found return null\n  if (noProxy !== '' && uriInNoProxy(uri, noProxy)) {\n    return null\n  }\n\n  // Check for HTTP or HTTPS Proxy in environment, else default to null\n  if (uri.protocol === 'http:') {\n    return process.env.HTTP_PROXY || process.env.http_proxy || null\n  }\n\n  if (uri.protocol === 'https:') {\n    return (\n      process.env.HTTPS_PROXY ||\n      process.env.https_proxy ||\n      process.env.HTTP_PROXY ||\n      process.env.http_proxy ||\n      null\n    )\n  }\n\n  // if none of that works, return null\n  // (What uri protocol are you using then?)\n  return null\n}\n\nfunction getHostFromUri(uri) {\n  let host = uri.host\n\n  // Drop :port suffix from Host header if known protocol.\n  if (uri.port) {\n    if (\n      (uri.port === '80' && uri.protocol === 'http:') ||\n      (uri.port === '443' && uri.protocol === 'https:')\n    ) {\n      host = uri.hostname\n    }\n  }\n\n  return host\n}\n\nfunction getHostHeaderWithPort(uri) {\n  const port = uri.port || (uri.protocol === 'https:' ? '443' : '80')\n  return `${uri.hostname}:${port}`\n}\n\nfunction rewriteUriForProxy(reqOpts, uri, proxy) {\n  const headers = reqOpts.headers || {}\n  const options = objectAssign({}, reqOpts, {headers})\n  headers.host = headers.host || getHostHeaderWithPort(uri)\n  options.protocol = proxy.protocol || options.protocol\n  options.hostname = proxy.host.replace(/:\\d+/, '')\n  options.port = proxy.port\n  options.host = getHostFromUri(objectAssign({}, uri, proxy))\n  options.href = `${options.protocol}//${options.host}${options.path}`\n  options.path = url.format(uri)\n  return options\n}\n\nfunction getProxyOptions(options) {\n  let proxy\n  if (options.hasOwnProperty('proxy')) {\n    proxy = options.proxy\n  } else {\n    const uri = url.parse(options.url)\n    proxy = getProxyFromUri(uri)\n  }\n\n  return typeof proxy === 'string' ? url.parse(proxy) : proxy\n}\n\nexports.rewriteUriForProxy = rewriteUriForProxy\nexports.getProxyOptions = getProxyOptions\n"],"file":"proxy.js"}